# E2E Tests

## CRITICAL: Analysis-First Approach

**DO NOT START IMPLEMENTATION** until you have completed ALL mandatory analysis steps.

⚠️ **FAILURE CONDITIONS - Test creation will be rejected if:**
- You skip reading ARCHITECTURE.md sections with the Read tool
- You skip reading NESTJS_BEST_PRACTICES.md with the Read tool
- You don't map all routes from Section 9 to test cases
- Authentication flow tests are not implemented
- Error handling tests are not included

---

## DATA SOURCES (Must Read Before Implementation)

### Primary Analysis Files (in output/ folder)
| File | Purpose | What to Extract |
|------|---------|-----------------|
| `output/analysis/legacy_analysis.json` | PHP function analysis | Expected behaviors |
| `output/analysis/routes.json` | Route mappings | All routes to test |
| `output/analysis/architecture_security_db.json` | Security issues | Security test cases |

### Architecture Reference (MUST READ WITH Read TOOL)
| File | Section | Line Range | Required Extractions |
|------|---------|------------|---------------------|
| `ARCHITECTURE.md` | **Section 9: Route Mapping** | Lines 820-970 | All routes with expected responses |
| `ARCHITECTURE.md` | **Section 12: Security** | Lines 1248-1340 | Auth requirements per route |
| `NESTJS_BEST_PRACTICES.md` | **Full file** | All | Testing patterns, supertest usage |

### Implementation Reference
| Directory | Purpose |
|-----------|---------|
| `apps/gateway/src/modules/` | Implemented modules to test |
| `apps/gateway/src/modules/**/*.spec.ts` | Unit test patterns to follow |
| `apps/gateway-e2e/` | E2E test location |

---

## PHASE 1: MANDATORY ANALYSIS (Must Complete Before Writing Code)

### Step 1.1: List All Implemented Routes

Execute this command to list all controller routes:

```bash
echo "=== IMPLEMENTED CONTROLLERS ==="
for controller in $(find apps/gateway/src/modules -name "*.controller.ts"); do
    echo ""
    echo "=== $controller ==="
    grep -E "@(Get|Post|Put|Delete|Patch)\(" "$controller" | head -20
done
```

### Step 1.2: Check Existing Test Patterns

```bash
echo "=== EXISTING UNIT TEST PATTERNS ==="
for spec in $(find apps/gateway/src/modules -name "*.spec.ts" | head -3); do
    echo ""
    echo "=== $spec ==="
    head -50 "$spec"
done
```

### Step 1.3: Check E2E Test Setup

```bash
if [ -d "apps/gateway-e2e" ]; then
    echo "=== E2E TEST SETUP ==="
    ls -la apps/gateway-e2e/

    if [ -f "apps/gateway-e2e/src/support/test-setup.ts" ]; then
        echo ""
        echo "=== TEST SETUP ==="
        cat apps/gateway-e2e/src/support/test-setup.ts
    fi
else
    echo "E2E test directory not found. Will need to create it."
fi
```

### Step 1.4: Read Security Issues for Test Cases

**IMPORTANT:** Security tests should cover identified vulnerabilities.

```bash
cat output/analysis/architecture_security_db.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

# Show ALL security types for test coverage
relevant_types = ['xss', 'sql_injection', 'command_injection', 'weak_crypto', 'insecure_function']

print('=== SECURITY ISSUES TO TEST ===')
print()
for issue_type in relevant_types:
    details = data.get('security', {}).get('by_type', {}).get(issue_type, {})
    affected = details.get('affected_files', [])
    if affected:
        print(f'{issue_type.upper()} ({len(affected)} files):')
        for f in affected[:3]:
            print(f'  - {f}')
        if len(affected) > 3:
            print(f'  ... and {len(affected) - 3} more')
        if details.get('examples'):
            ex = details['examples'][0]
            print(f'  Test: Verify {ex.get(\"recommendation\", \"N/A\")}')
        print()
"
```

### Step 1.5: READ ARCHITECTURE.md Section 9 - Routes (MANDATORY)

**YOU MUST USE THE Read TOOL** to read this section:

```
Read tool parameters:
  file_path: output/analysis/ARCHITECTURE.md
  offset: 820
  limit: 150
```

**Extract and document for E2E tests:**
- [ ] All routes grouped by module
- [ ] HTTP methods for each route
- [ ] Path parameters and query parameters
- [ ] Expected response formats
- [ ] Authentication requirements per route

### Step 1.6: READ ARCHITECTURE.md Section 12 - Security (MANDATORY)

**YOU MUST USE THE Read TOOL** to read this section:

```
Read tool parameters:
  file_path: output/analysis/ARCHITECTURE.md
  offset: 1248
  limit: 95
```

**Extract and document:**
- [ ] Which routes require authentication
- [ ] Rate limiting configuration to test
- [ ] Input validation requirements
- [ ] Error response formats

### Step 1.7: READ NESTJS_BEST_PRACTICES.md (MANDATORY)

**YOU MUST USE THE Read TOOL** to read the relevant section:

```
Read tool parameters:
  file_path: output/analysis/NESTJS_BEST_PRACTICES.md
  offset: 1
  limit: 300
```

**Extract patterns for:**
- [ ] E2E test setup patterns
- [ ] supertest usage
- [ ] Test module configuration
- [ ] Database seeding for tests
- [ ] Authentication mocking

### Step 1.8: Read Routes Analysis

```bash
cat output/analysis/routes.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

print('=== ALL ROUTES TO TEST ===')
print()

# Group by module
routes_by_module = {}
for r in data.get('routes', []):
    path = r.get('nestjs_path', '')
    # Extract module from path
    parts = path.strip('/').split('/')
    module = parts[0] if parts else 'root'

    if module not in routes_by_module:
        routes_by_module[module] = []
    routes_by_module[module].append(r)

for module, routes in sorted(routes_by_module.items()):
    print(f'{module.upper()} ({len(routes)} routes):')
    for r in routes[:5]:
        method = r.get('nestjs_method', 'GET')
        path = r.get('nestjs_path', '/')
        auth = '[AUTH]' if r.get('requires_auth') else ''
        print(f'  {method} {path} {auth}')
    if len(routes) > 5:
        print(f'  ... and {len(routes) - 5} more')
    print()
"
```

### Step 1.9: Create Test Case Mapping Table

Based on ALL the analysis above, create a complete test case mapping:

| Route | Method | Test Cases | Auth Required | Priority |
|-------|--------|------------|---------------|----------|
| /config | GET | Returns config object | No | High |
| /settings | GET | Returns settings object | No | High |
| /ping | GET | Returns 200 OK | No | High |
| /item/:id | GET | Valid ID returns product, Invalid ID returns 404 | No | High |
| /items/:id/similar | GET | Returns similar products array | No | Medium |
| /popular_items/:cat | GET | Returns popular items for category | No | Medium |
| /cats | GET | Returns all categories | No | High |
| /category/:id | GET | Returns category with products | No | High |
| /auth/login | POST | Valid credentials returns token, Invalid returns 401 | No | Critical |
| /auth/me | GET | With token returns user, Without token returns 401 | Yes | Critical |
| /searchPage | GET | Returns search results | No | High |
| /products/search/autocomplete/:query | GET | Returns suggestions array | No | Medium |

---

## PHASE 2: ARCHITECTURE CONTEXT

### E2E Test Structure

```
apps/gateway-e2e/
├── src/
│   ├── gateway/
│   │   ├── config.spec.ts
│   │   ├── products.spec.ts
│   │   ├── categories.spec.ts
│   │   ├── auth.spec.ts
│   │   ├── search.spec.ts
│   │   └── error-handling.spec.ts
│   └── support/
│       ├── test-setup.ts
│       ├── test-helpers.ts
│       └── mock-data.ts
├── jest.config.ts
├── tsconfig.json
└── project.json
```

### Critical Paths to Test (from ARCHITECTURE.md Section 9)

#### 1. Config Endpoints
```typescript
describe('Config Endpoints', () => {
  it('GET /config - Should return app configuration', async () => {
    const response = await request(app.getHttpServer())
      .get('/config')
      .expect(200);
    expect(response.body).toHaveProperty('version');
  });

  it('GET /settings - Should return app settings', async () => {
    const response = await request(app.getHttpServer())
      .get('/settings')
      .expect(200);
    expect(response.body).toHaveProperty('settings');
  });

  it('GET /ping - Should return health status', async () => {
    await request(app.getHttpServer())
      .get('/ping')
      .expect(200);
  });
});
```

#### 2. Product Endpoints
```typescript
describe('Product Endpoints', () => {
  it('GET /item/:id - Should return product details', async () => {
    const response = await request(app.getHttpServer())
      .get('/item/123')
      .expect(200);
    expect(response.body).toHaveProperty('id');
  });

  it('GET /item/:id - Should return 404 for non-existent product', async () => {
    await request(app.getHttpServer())
      .get('/item/999999')
      .expect(404);
  });

  it('GET /items/:id/similar - Should return similar products', async () => {
    const response = await request(app.getHttpServer())
      .get('/items/123/similar')
      .expect(200);
    expect(Array.isArray(response.body)).toBe(true);
  });
});
```

#### 3. Category Endpoints
```typescript
describe('Category Endpoints', () => {
  it('GET /cats - Should return all categories', async () => {
    const response = await request(app.getHttpServer())
      .get('/cats')
      .expect(200);
    expect(Array.isArray(response.body)).toBe(true);
  });

  it('GET /category/:id - Should return category with products', async () => {
    const response = await request(app.getHttpServer())
      .get('/category/1')
      .expect(200);
    expect(response.body).toHaveProperty('id');
  });
});
```

#### 4. Auth Flow
```typescript
describe('Auth Flow', () => {
  let authToken: string;

  it('POST /auth/login - Should authenticate user', async () => {
    const response = await request(app.getHttpServer())
      .post('/auth/login')
      .send({ email: 'test@example.com', password: 'password' })
      .expect(200);
    expect(response.body).toHaveProperty('access_token');
    authToken = response.body.access_token;
  });

  it('GET /auth/me - Should return current user (with token)', async () => {
    const response = await request(app.getHttpServer())
      .get('/auth/me')
      .set('Authorization', `Bearer ${authToken}`)
      .expect(200);
    expect(response.body).toHaveProperty('email');
  });

  it('GET /auth/me - Should reject without token', async () => {
    await request(app.getHttpServer())
      .get('/auth/me')
      .expect(401);
  });
});
```

#### 5. Search Endpoints
```typescript
describe('Search Endpoints', () => {
  it('GET /searchPage - Should return search results', async () => {
    const response = await request(app.getHttpServer())
      .get('/searchPage')
      .query({ q: 'test' })
      .expect(200);
    expect(response.body).toHaveProperty('results');
  });

  it('GET /products/search/autocomplete/:query - Should return suggestions', async () => {
    const response = await request(app.getHttpServer())
      .get('/products/search/autocomplete/test')
      .expect(200);
    expect(Array.isArray(response.body)).toBe(true);
  });
});
```

#### 6. Error Handling
```typescript
describe('Error Handling', () => {
  it('Should return 404 for unknown routes', async () => {
    await request(app.getHttpServer())
      .get('/unknown-route')
      .expect(404);
  });

  it('Should return 400 for invalid input', async () => {
    await request(app.getHttpServer())
      .post('/auth/login')
      .send({ email: 'invalid' })
      .expect(400);
  });

  it('Should return consistent error format', async () => {
    const response = await request(app.getHttpServer())
      .get('/unknown-route')
      .expect(404);
    expect(response.body).toHaveProperty('statusCode');
    expect(response.body).toHaveProperty('message');
  });
});
```

### Security Test Requirements (from ARCHITECTURE.md Section 12)

| Test Category | What to Test |
|---------------|--------------|
| Auth required routes | Verify 401 without token |
| Token validation | Verify invalid tokens rejected |
| Input validation | Verify malformed input returns 400 |
| Rate limiting | Verify throttling after limit exceeded |
| SQL injection | Verify parameterized queries prevent injection |
| XSS | Verify output is properly escaped |

---

## PHASE 3: IMPLEMENTATION

**Only proceed after PHASE 1 and PHASE 2 are complete.**

### Target Location
- E2E tests: `apps/gateway-e2e/src/`
- Project: `m-action-nestjs`

### Implementation Requirements

1. **Test Setup (`support/test-setup.ts`)**:
   - Configure test app with Testing module
   - Set up database seeding
   - Configure authentication helper

2. **Test Helpers (`support/test-helpers.ts`)**:
   - `getAuthToken()` - Get valid JWT for authenticated tests
   - `seedDatabase()` - Insert test data
   - `cleanDatabase()` - Reset test data

3. **Mock Data (`support/mock-data.ts`)**:
   - Test users
   - Test products
   - Test categories

4. **Test Files**:
   - One file per module/endpoint group
   - Use supertest for HTTP assertions
   - Mock external services (SEO, Payment)

5. **Coverage Requirements**:
   - All routes from ARCHITECTURE.md Section 9
   - Happy path and error cases
   - Authentication flow
   - Input validation

---

## PHASE 4: VERIFICATION

### Pre-Implementation Checklist

**Analysis Steps (ALL REQUIRED):**
- [ ] Step 1.1: Listed all implemented routes
- [ ] Step 1.2: Checked existing test patterns
- [ ] Step 1.3: Checked E2E test setup
- [ ] Step 1.4: Executed security issues extraction
- [ ] **Step 1.5: READ ARCHITECTURE.md Section 9** (routes)
- [ ] **Step 1.6: READ ARCHITECTURE.md Section 12** (security)
- [ ] **Step 1.7: READ NESTJS_BEST_PRACTICES.md**
- [ ] Step 1.8: Executed routes analysis extraction
- [ ] Step 1.9: Created complete test case mapping table

**Understanding Verified:**
- [ ] All routes to test identified
- [ ] Authentication requirements per route documented
- [ ] Expected response formats understood
- [ ] Error handling patterns documented

### Post-Implementation Checklist

- [ ] E2E test files created in `apps/gateway-e2e/src/`
- [ ] Test setup configured with supertest
- [ ] All route groups tested:
  - [ ] Config endpoints (GET /config, /settings, /ping)
  - [ ] Product endpoints (GET /item/:id, /items/:id/similar, /popular_items/:cat)
  - [ ] Category endpoints (GET /cats, /category/:id)
  - [ ] Auth flow (POST /auth/login, GET /auth/me)
  - [ ] Search endpoints (GET /searchPage, /products/search/autocomplete/:query)
- [ ] Error handling tests:
  - [ ] 404 for unknown routes
  - [ ] 401 for protected routes without token
  - [ ] 400 for invalid input
- [ ] External services mocked (SEO, Payment)
- [ ] All E2E tests pass

### Validation Commands
```bash
# Run E2E tests
nx e2e gateway-e2e

# Run with verbose output
nx e2e gateway-e2e --verbose

# Run specific test file
nx e2e gateway-e2e --testFile=auth.spec.ts
```

---

## COMPLETION

When ALL verifications pass:
```
SERVICE_COMPLETE
```

If stuck after analysis:
```
NEEDS_REVIEW: [describe the blocking issue]
```
