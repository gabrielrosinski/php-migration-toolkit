# Content Module Migration

## CRITICAL: Analysis-First Approach

**DO NOT START IMPLEMENTATION** until you have completed ALL mandatory analysis steps.

⚠️ **FAILURE CONDITIONS - Migration will be rejected if:**
- You skip reading ARCHITECTURE.md sections with the Read tool
- You skip reading NESTJS_BEST_PRACTICES.md with the Read tool
- You don't create a function mapping table
- Security requirements are not applied

---

## DATA SOURCES (Must Read Before Implementation)

### Primary Analysis Files (in output/ folder)
| File | Purpose | What to Extract |
|------|---------|-----------------|
| `output/analysis/legacy_analysis.json` | PHP function analysis | Functions, parameters, DB calls, globals |
| `output/analysis/routes.json` | Route mappings | HTTP method, NestJS path, query params |
| `output/analysis/architecture_security_db.json` | Security issues | XSS, SQL injection, weak crypto |

### Architecture Reference (MUST READ WITH Read TOOL)
| File | Section | Line Range | Required Extractions |
|------|---------|------------|---------------------|
| `ARCHITECTURE.md` | **Section 9: Route Mapping** | Lines 820-970 | Routes for this module |
| `ARCHITECTURE.md` | **Section 12: Security** | Lines 1248-1340 | crypto.randomBytes, bcrypt, validation |
| `NESTJS_BEST_PRACTICES.md` | **Full file** | All | Patterns, decorators, testing |

### Database (Import entities, don't recreate)
| File | Purpose |
|------|---------|
| `output/database/entities/*.ts` | TypeORM entities - import from `@m-action-nestjs/database` |
| `output/database/modules/schema_content.json` | Full database schema reference |

---

## PHASE 1: MANDATORY ANALYSIS (Must Complete Before Writing Code)

### Step 1.1: Read PHP Source Files Analysis

Execute this command to extract PHP functions for this module:

```bash
cat output/analysis/legacy_analysis.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

# Target PHP files for this module
target_files = ['files/page.php', 'routes/menu/index.php', 'routes/home/index.php', 'routes/footer/index.php', 'routes/slider/index.php', 'routes/banner/index.php', 'routes/article/index.php', 'routes/news/index.php']

all_files = data.get('all_files', [])
found_any = False
for f in all_files:
    path = f.get('path', '')
    if any(t in path for t in target_files):
        found_any = True
        print(f'\\n=== {path.split(\"m-action/\")[-1]} ===')
        print(f'Lines: {f.get(\"total_lines\")}')
        for fn in f.get('functions', []):
            params = ', '.join(fn.get('params', []))
            db = '[DB]' if fn.get('calls_db') else ''
            globals_used = fn.get('uses_globals', [])
            print(f'  - {fn.get(\"name\")}({params}) {db}')
            if globals_used:
                print(f'    Globals: {globals_used}')

if not found_any:
    print('WARNING: No matching files found.')
    print('Check ARCHITECTURE.md Section 9 for route definitions.')
    print('Routes may be NEW endpoints not in legacy code.')
"
```

### Step 1.2: Read Routes Analysis

```bash
cat output/analysis/routes.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

target_files = ['menu', 'home', 'footer', 'slider', 'banner', 'article', 'page', 'news', 'header']

found_any = False
for r in data.get('routes', []):
    target = r.get('target_file', '')
    path = r.get('nestjs_path', '')
    if any(t in target for t in target_files) or any(t in path.lower() for t in target_files):
        found_any = True
        print(f\"{r.get('nestjs_method')} {r.get('nestjs_path')} -> {target}\")
        if r.get('query_params'):
            print(f\"  Query params: {r.get('query_params')}\")

if not found_any:
    print('WARNING: No matching routes found in routes.json.')
    print('Check ARCHITECTURE.md Section 9 for route definitions.')
"
```

### Step 1.3: Read Security Issues

**IMPORTANT:** Security issues affect modules even if files aren't named for this module.

```bash
cat output/analysis/architecture_security_db.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

# Show ALL security types relevant to backend modules
relevant_types = ['xss', 'sql_injection', 'command_injection', 'weak_crypto', 'insecure_function']

print('=== SECURITY ISSUES TO ADDRESS ===')
print()
for issue_type in relevant_types:
    details = data.get('security', {}).get('by_type', {}).get(issue_type, {})
    affected = details.get('affected_files', [])
    if affected:
        print(f'{issue_type.upper()} ({len(affected)} files):')
        for f in affected[:3]:
            print(f'  - {f}')
        if len(affected) > 3:
            print(f'  ... and {len(affected) - 3} more')
        if details.get('examples'):
            ex = details['examples'][0]
            print(f'  Remediation: {ex.get(\"recommendation\", \"N/A\")}')
        print()
"
```

### Step 1.4: READ ARCHITECTURE.md Section 9 - Routes (MANDATORY)

**YOU MUST USE THE Read TOOL** to read this section:

```
Read tool parameters:
  file_path: output/analysis/ARCHITECTURE.md
  offset: 820
  limit: 150
```

**Extract and document for this module:**
- [ ] All routes that belong to Content
- [ ] HTTP methods (GET, POST, PUT, DELETE)
- [ ] Path parameters and query parameters
- [ ] Response formats

### Step 1.5: READ ARCHITECTURE.md Section 12 - Security (MANDATORY)

**YOU MUST USE THE Read TOOL** to read this section:

```
Read tool parameters:
  file_path: output/analysis/ARCHITECTURE.md
  offset: 1248
  limit: 95
```

**Extract and document:**
- [ ] Use `crypto.randomBytes()` for tokens (NOT Math.random())
- [ ] Use `bcrypt` for password hashing
- [ ] Use TypeORM parameterized queries (NOT string concatenation)
- [ ] Sanitize all user inputs

### Step 1.6: READ NESTJS_BEST_PRACTICES.md (MANDATORY)

**YOU MUST USE THE Read TOOL** to read the relevant section:

```
Read tool parameters:
  file_path: output/analysis/NESTJS_BEST_PRACTICES.md
  offset: 1
  limit: 300
```

**Extract patterns for:**
- [ ] Module structure
- [ ] Service patterns
- [ ] Controller patterns
- [ ] DTO validation
- [ ] Repository usage

### Step 1.7: Read Database Schema (MANDATORY)

**YOU MUST USE THE Read TOOL:**

```
Read tool parameters:
  file_path: output/database/modules/schema_content.json
```

**Extract tables relevant to this module.**

### Step 1.8: Create Function Mapping Table

Based on ALL the analysis above, create a complete mapping table:

| PHP Function | Parameters | DB? | NestJS Method | Security Fix | Notes |
|-------------|------------|-----|---------------|--------------|-------|
| getMenu | $lang | Yes | getMenu | Parameterized queries | Main navigation |
| getHeaderMenu | $lang | Yes | getHeaderMenu | - | Header menu items |
| getHomepage | $lang | Yes | getHomepage | XSS sanitization | Homepage content |
| getSlider | $world | Yes | getSlider | - | Homepage carousel |
| getFooter | - | Yes | getFooter | - | Footer content |
| getBanner | $position, $world | Yes | getBanner | - | Banner ads |
| getPage | $slug | Yes | getPage | XSS sanitization | Static pages |
| ... | ... | ... | ... | ... | ... |

**If Step 1.1 returned no functions:**
Use routes from ARCHITECTURE.md Section 9 (Step 1.4) as your function mapping.

---

## PHASE 2: ARCHITECTURE CONTEXT

### Routes to Implement (from ARCHITECTURE.md Section 9)

| Legacy Route | NestJS Route | Description |
|--------------|--------------|-------------|
| GET /menu | GET /menu | Main navigation menu with categories |
| GET /header-menu | GET /header-menu | Header menu items |
| GET /home | GET /home | Homepage content |
| GET /top | GET /top | Top section content |
| GET /slider | GET /slider | Homepage slider/carousel |
| GET /footer | GET /footer | Footer content |
| GET /footer-items | GET /footer-items | Footer menu items |
| GET /banner | GET /banner | Banner ads |
| GET /article | GET /article | Article by URL query param |
| GET /page/:slug | GET /page/:slug | Static pages |
| GET /news | GET /news | New arrivals/news items |
| GET /featured-content | GET /featured-content | Featured content by route/type |

### Entities to Use

- `Katava` - Static pages content
- `ApiFooterMenu` - Footer menu items
- `ZCarousel` - Carousel/slider items
- `ZXslider2Banners` - Slider banners
- `IBanner` - Banner ads

**IMPORTANT:** Import from `@m-action-nestjs/database`, do not recreate.

### Security Requirements (from ARCHITECTURE.md Section 12)

| Requirement | How to Implement |
|-------------|------------------|
| No weak crypto | Use `crypto.randomBytes()` for tokens |
| Password hashing | Use `bcrypt` with salt rounds >= 10 |
| SQL injection prevention | Use TypeORM Repository methods only |
| XSS prevention | Use `class-transformer` @Expose/@Exclude |
| Input validation | Use `class-validator` decorators on ALL DTOs |

---

## PHASE 3: IMPLEMENTATION

**Only proceed after PHASE 1 and PHASE 2 are complete.**

### Target Location
- Module: `apps/gateway/src/modules/content/`
- Project: `m-action-nestjs`

### Implementation Requirements

1. **Service Methods**: Implement ALL PHP functions from Phase 1 mapping
2. **Controller Routes**: Map ALL routes from Phase 2
3. **DTOs**: Create validated DTOs with `class-validator`
4. **Caching**: Add `@nestjs/cache-manager` where PHP used Redis
5. **Security**: Apply ALL security fixes from Section 12
6. **Tests**: Unit tests with >80% coverage

---

## PHASE 4: VERIFICATION

### Pre-Implementation Checklist

**Analysis Steps (ALL REQUIRED):**
- [ ] Step 1.1: Executed PHP function extraction
- [ ] Step 1.2: Executed routes extraction
- [ ] Step 1.3: Executed security issues extraction
- [ ] **Step 1.4: READ ARCHITECTURE.md Section 9** (routes)
- [ ] **Step 1.5: READ ARCHITECTURE.md Section 12** (security)
- [ ] **Step 1.6: READ NESTJS_BEST_PRACTICES.md**
- [ ] **Step 1.7: READ schema_inferred.json**
- [ ] Step 1.8: Created complete function mapping table

**Understanding Verified:**
- [ ] All routes for this module identified
- [ ] All database tables identified
- [ ] Security requirements documented
- [ ] NestJS patterns understood

### Post-Implementation Checklist

- [ ] All routes mapped in controller
- [ ] All PHP functions have NestJS equivalents
- [ ] DTOs have proper validation (`class-validator`)
- [ ] Entities imported from `@m-action-nestjs/database`
- [ ] Security fixes applied:
  - [ ] `crypto.randomBytes()` used (NOT Math.random())
  - [ ] TypeORM parameterized queries (NO string SQL)
  - [ ] Input sanitization applied
- [ ] Tests pass with >80% coverage

### Validation Commands
```bash
npx nx test gateway --testPathPattern="content"
npx nx build gateway
```

---

## COMPLETION

When ALL verifications pass:
```
SERVICE_COMPLETE
```

If stuck after analysis:
```
NEEDS_REVIEW: [describe the blocking issue]
```
