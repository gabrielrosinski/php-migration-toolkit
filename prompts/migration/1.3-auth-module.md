# Auth Module Migration

## CRITICAL: Analysis-First Approach

**DO NOT START IMPLEMENTATION** until you have completed the mandatory analysis phase.

---

## DATA SOURCES (Must Read Before Implementation)

### Primary Analysis Files (in output/ folder)
| File | Purpose | What to Extract |
|------|---------|-----------------|
| `output/analysis/legacy_analysis.json` | PHP function analysis | Functions, parameters, DB calls, globals, complexity |
| `output/analysis/routes.json` | Route mappings | HTTP method, NestJS path, query params, target file |
| `output/analysis/architecture_security_db.json` | Security issues | weak_crypto (for tokens), XSS, SQL injection |

### Architecture Reference (MUST READ SPECIFIC SECTIONS)
| File | Sections to Read | Line Range |
|------|------------------|------------|
| `output/analysis/ARCHITECTURE.md` | **Section 6: Authentication Strategy** | Lines 529-660 |
| `output/analysis/ARCHITECTURE.md` | **Section 12: Security Remediation** | Lines 1248-1340 |
| `output/analysis/NESTJS_BEST_PRACTICES.md` | Section 4: Security | Full file |

### Database (Import entities, don't recreate)
| File | Purpose |
|------|---------|
| `output/database/entities/app-auth-tokens.entity.ts` | JWT refresh tokens |
| `output/database/entities/app-auth-logs.entity.ts` | Authentication logs |
| `output/database/entities/app-devices.entity.ts` | User devices |

---

## PHASE 1: MANDATORY ANALYSIS (Must Complete Before Writing Code)

### Step 1.1: Read PHP Source Files Analysis

Execute this command to extract the PHP functions for this module:

```bash
cat output/analysis/legacy_analysis.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

target_files = ['routes/auth/index.php', 'files/auth.php', 'routes/amex/index.php', 'files/login.php', 'files/session.php', 'amex/login.php']

all_files = data.get('all_files', [])
found_any = False
for f in all_files:
    path = f.get('path', '')
    if any(t in path for t in target_files):
        found_any = True
        print(f'\\n=== {path.split(\"m-action/\")[-1]} ===')
        print(f'Lines: {f.get(\"total_lines\")}')
        for fn in f.get('functions', []):
            params = ', '.join(fn.get('params', []))
            db = '[DB]' if fn.get('calls_db') else ''
            globals_used = fn.get('uses_globals', [])
            print(f'  - {fn.get(\"name\")}({params}) {db}')
            if globals_used:
                print(f'    Globals: {globals_used}')

if not found_any:
    print('WARNING: No matching auth files found in legacy analysis.')
    print('This may indicate auth is handled inline or in different files.')
    print('Check ARCHITECTURE.md Section 6 for auth design requirements.')
"
```

### Step 1.2: Read Routes Analysis

```bash
cat output/analysis/routes.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

target_files = ['auth', 'amex', 'login']

found_any = False
for r in data.get('routes', []):
    target = r.get('target_file', '')
    path = r.get('nestjs_path', '')
    if any(t in target for t in target_files) or 'auth' in path.lower():
        found_any = True
        print(f\"{r.get('nestjs_method')} {r.get('nestjs_path')} -> {target}\")
        if r.get('query_params'):
            print(f\"  Query params: {r.get('query_params')}\")

if not found_any:
    print('WARNING: No auth routes found in routes.json.')
    print('Auth routes are likely NEW endpoints defined in ARCHITECTURE.md Section 6.')
"
```

### Step 1.3: Read Security Issues (Auth-Relevant)

**IMPORTANT:** Auth modules are affected by weak_crypto issues (token generation) even if files aren't named 'auth'.

```bash
cat output/analysis/architecture_security_db.json | python3 -c "
import json, sys
data = json.load(sys.stdin)

# Auth is affected by: weak_crypto (tokens), sql_injection (user queries), xss (user data)
auth_relevant_types = ['weak_crypto', 'sql_injection', 'insecure_function']

print('=== SECURITY ISSUES RELEVANT TO AUTH MODULE ===')
print()
for issue_type in auth_relevant_types:
    details = data.get('security', {}).get('by_type', {}).get(issue_type, {})
    affected = details.get('affected_files', [])
    if affected:
        print(f'{issue_type.upper()} ({len(affected)} files):')
        for f in affected[:5]:
            print(f'  - {f}')
        if len(affected) > 5:
            print(f'  ... and {len(affected) - 5} more')
        if details.get('examples'):
            ex = details['examples'][0]
            print(f'  Example: {ex.get(\"code\", \"N/A\")[:60]}...')
            print(f'  Remediation: {ex.get(\"recommendation\", \"N/A\")}')
        print()
"
```

### Step 1.4: READ ARCHITECTURE.md Section 6 (MANDATORY)

**YOU MUST USE THE Read TOOL** to read ARCHITECTURE.md lines 529-660:

```
Read tool parameters:
  file_path: output/analysis/ARCHITECTURE.md
  offset: 529
  limit: 135
```

**Extract and document:**
- [ ] JWT + Redis Session Hybrid decision
- [ ] PHP Session Mapping table
- [ ] Guards Implementation pattern
- [ ] Migration phases (Phase 1, 2, 3)

### Step 1.5: READ ARCHITECTURE.md Section 12 (MANDATORY)

**YOU MUST USE THE Read TOOL** to read ARCHITECTURE.md lines 1248-1340:

```
Read tool parameters:
  file_path: output/analysis/ARCHITECTURE.md
  offset: 1248
  limit: 95
```

**Extract and document:**
- [ ] Weak Crypto remediation (crypto.randomBytes)
- [ ] Password hashing requirement (bcrypt)

### Step 1.6: READ NESTJS_BEST_PRACTICES.md Section 4 (MANDATORY)

**YOU MUST USE THE Read TOOL** to read the Security section:

```
Read tool parameters:
  file_path: output/analysis/NESTJS_BEST_PRACTICES.md
  offset: 499
  limit: 200
```

### Step 1.7: Create Function Mapping Table

**YOU MUST CREATE THIS TABLE** based on the analysis output above:

| PHP Function | Parameters | DB? | NestJS Method | Business Logic |
|-------------|------------|-----|---------------|----------------|
| (from Step 1.1 output) | | | | |

**If Step 1.1 returned no functions:**
Use routes from ARCHITECTURE.md Section 6 as your function mapping.

---

## PHASE 2: ARCHITECTURE CONTEXT

### Routes to Implement (from ARCHITECTURE.md Section 6)

| Legacy Route | NestJS Route | Description |
|--------------|--------------|-------------|
| POST /auth/login | POST /auth/login | User login |
| POST /auth/logout | POST /auth/logout | User logout |
| POST /auth/refresh | POST /auth/refresh | Refresh JWT token |
| GET /auth/me | GET /auth/me | Get current user |
| GET /amex/login | GET /amex/login | Amex OAuth login |

### Entities to Use (from libs/database/src/entities/)

- `AppAuthTokens` - JWT refresh tokens
- `AppAuthLogs` - Authentication logs
- `AppDevices` - User devices

### Security Requirements (from ARCHITECTURE.md Section 12)

- Use `crypto.randomBytes()` for token generation (NOT Math.random())
- Use `bcrypt` for password hashing
- Use `@nestjs/jwt` for token management
- Use `@nestjs/passport` for authentication strategies
- Implement proper token rotation
- Log all authentication events

### Hybrid Auth Requirement (from ARCHITECTURE.md Section 6)

**DECISION: JWT + Redis Session Hybrid**

During migration, support BOTH:
1. **JWT** (for new clients, mobile apps)
2. **PHP Session validation** (for legacy PHP during transition)

Migration Phases:
- Phase 1: Support both JWT and PHP session cookies â† **IMPLEMENT THIS**
- Phase 2: Migrate all clients to JWT
- Phase 3: Remove PHP session support

---

## PHASE 3: IMPLEMENTATION

**Only proceed after completing PHASE 1 and PHASE 2.**

### Target Location
- Module: `apps/gateway/src/modules/auth/`
- Project: `m-action-nestjs`

### Implementation Requirements

1. **Service Methods**: Implement ALL routes from Phase 2
2. **Controller Routes**: Map ALL routes from Phase 2
3. **Guards**: Create `JwtAuthGuard`, `HybridAuthGuard`, `RolesGuard`
4. **Decorators**: Create `@CurrentUser()`, `@Public()`, `@Roles()`
5. **Strategies**: Implement JWT strategy with access + refresh tokens
6. **PHP Session Service**: Validate legacy PHP sessions from Redis
7. **DTOs**: Create validated DTOs for login, refresh
8. **Tests**: Unit tests with >80% coverage

---

## PHASE 4: VERIFICATION

### Pre-Implementation Checklist
- [ ] Executed Step 1.1 (PHP functions)
- [ ] Executed Step 1.2 (Routes)
- [ ] Executed Step 1.3 (Security issues)
- [ ] **READ Step 1.4** (ARCHITECTURE.md Section 6) - Verified JWT+Session hybrid
- [ ] **READ Step 1.5** (ARCHITECTURE.md Section 12) - Verified crypto requirements
- [ ] **READ Step 1.6** (NESTJS_BEST_PRACTICES.md Security) - Verified patterns
- [ ] Created function mapping table

### Post-Implementation Checklist
- [ ] All routes mapped in controller
- [ ] JWT authentication working
- [ ] PHP Session hybrid support (HybridAuthGuard)
- [ ] Guards properly implemented
- [ ] Decorators working correctly
- [ ] DTOs have proper validation
- [ ] crypto.randomBytes() used (NOT Math.random())
- [ ] bcrypt used for password hashing
- [ ] Tests pass with >80% coverage

### Validation Commands
```bash
nx test gateway --testPathPattern="auth"
nx build gateway
```

---

## COMPLETION

When all verifications pass:
```
SERVICE_COMPLETE
```

If stuck after analysis:
```
NEEDS_REVIEW: [describe the blocking issue]
```
